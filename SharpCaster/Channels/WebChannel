using System;
using System.Threading.Tasks;
using Newtonsoft.Json;
using SharpCaster.Models;
using SharpCaster.Models.CustomTypes;
using SharpCaster.Models.ChromecastRequests;
using SharpCaster.Models.MediaStatus;
using System.Linq;

namespace SharpCaster.Channels
{
    public class WebChannel : ChromecastChannel
    {
        public event EventHandler<string> ScreenIdChanged;

        public WebChannel(ChromeCastClient client) : base(client, MessageFactory.DialConstants.WebUrl)
        {
            MessageReceived += OnMessageReceived;
        }

        private void OnMessageReceived(object sender, ChromecastSSLClientDataReceivedArgs chromecastSSLClientDataReceivedArgs)
        {
            var json = chromecastSSLClientDataReceivedArgs.Message.PayloadUtf8;
            var response = JsonConvert.DeserializeObject<MediaStatusResponse>(json);
            if (response.status == null) return; //TODO: Should probably raise LOAD_FAILED event
            if (response.status.Count == 0) return; //Initializing
            Client.MediaStatus = response.status.First();
            if (Client.MediaStatus.Volume != null) Client.Volume = Client.MediaStatus.Volume;
            Client.CurrentMediaSessionId = Client.MediaStatus.MediaSessionId;
        }

        public async Task LoadUrl(string strUrl)
        {
            var req = new UrlRequest(Client.CurrentApplicationSessionId, strUrl);

            var reqJson = req.ToJson();
            await Write(MessageFactory.Load(Client.CurrentApplicationTransportId, reqJson));
        }

        public async Task GetMediaStatus()
        {
            await Write(MessageFactory.MediaStatus(Client.CurrentApplicationTransportId));
        }

        public async void GetChromecastStatus()
        {
            await Write(MessageFactory.Status());
        }

        public async Task Play()
        {
            //Plex uses the same messages as the Google Media messages but on its own namespace
            var castMessage = MessageFactory.Play(Client.CurrentApplicationTransportId, Client.CurrentMediaSessionId);

            await Write(castMessage);
        }

        public async Task Pause()
        {
            //Plex uses the same messages as the Google Media messages but on its own namespace
            var castMessage = MessageFactory.Pause(Client.CurrentApplicationTransportId, Client.CurrentMediaSessionId);
            
            await Write(castMessage);
        }

        public async Task Seek(double seconds)
        {
            //Plex uses the same messages as the Google Media messages but on its own namespace
            var castMessage = MessageFactory.Seek(Client.CurrentApplicationTransportId, Client.CurrentMediaSessionId, seconds);

            await Write(castMessage);
        }

        public async Task StopApplication()
        {
            await Write(MessageFactory.StopApplication(Client.CurrentApplicationSessionId));
        }

        public async Task Stop()
        {
            await Write(MessageFactory.StopMedia(Client.CurrentMediaSessionId));
        }

        public async Task Next()
        {
            await Write(MessageFactory.Next(Client.CurrentApplicationTransportId, Client.CurrentMediaSessionId));
        }

        public async Task Previous()
        {
            await Write(MessageFactory.Previous(Client.CurrentApplicationTransportId, Client.CurrentMediaSessionId));
        }
    }
}
